# snRNA-Seq: CellRanger

## Getting Started

You first need [an account](https://docs.rc.uab.edu/account_management/cheaha_account/) on the HPC (Cheaha).

You also need access to the `/data/project/daylab` directory. This directory houses all of our sequencing projects. To get access to the project directory once you have an HPC account, contact Jeremy.

If this is your first time using Cheaha, please read the [Research Computing documentation](https://docs.rc.uab.edu/cheaha/getting_started/) to learn some of the basics.

## Getting raw data onto Cheaha

To start, first transfer your RNA-seq `*.fastq` files onto Cheaha in the daylab project folder. For new projects, create a new directory using the naming convention outlined in `/data/project/daylab/Experiment_Directory/`

Files can be transferred most efficiently by using established Globus Endpoints at the UAB Box folder and Cheaha. Instructions on how to do this can be found [at this link](https://docs.rc.uab.edu/data_management/transfer/globus/). Note that which Cheaha endpoint you use depends on whether you are currently on campus or off campus. To transfer files to/from your computer's hard drive, use your personal Globus endpoint (see link for instructions).

Best practice is to create a subdirectory that houses all of the FASTQ files.

## Generate reference genome

CellRanger requires a reference genome directory in a specific format. If this is the first time you are using a particular reference (including specific version) with standard CellRanger (*not* CellRanger ATAC or CellRanger ARC), you will need to first create the CellRanger reference with `cellranger mkref`.

For running jobs on HPC, I typically set a working directory and sometimes also a data directory. For `mkref`, my data directory (`$DATA_DIR`) points to the parent location of the genome files. The working directory is a new folder I created in `$USER_SCRATCH`.

To run `mkref`, first load the CellRanger module, then call `cellranger mkref`, specifying the output genome name (mRatBN7_2), the number of threads to use, and the locations of the FASTA and GTF genome files. (Adding `date` at the end will timestamp the end of the job in your HPC outfile.)

```
export DATA_DIR=/data/project/daylab/2023-JD-0062
export WORK_DIR=/scratch/cenewman/mkref
cd $WORK_DIR

module load CellRanger

cellranger mkref --genome=mRatBN7_2 \
                 --fasta=$DATA_DIR/custom_rn7_outs/Rattus_norvegicus.mRatBN7.2.dna.toplevel_Chimera.fa \
                 --genes=$DATA_DIR/custom_rn7_outs/GTF/Rattus_norvegicus.mRatBN7.2.109_Chimera.gtf \
                 --nthreads=6

date
```

Once the job is finished, you should see in your output directory a folder with your genome name (`mRatBN7_2`). That's the directory you will point to for running CellRanger `count` next. **Move this directory out of $USER_SCRATCH to your $USER_DATA directory for storage.**

```
mv $USER_SCRATCH/path/to/outputdir $USER_DATA
```

In that genome directory should be the following structure:

```
mRatBN7_2
└── fasta
    ├── genome.fa
    ├── genome.fa.fai
└── genes
    ├── genes.gtf.gz
└── reference.json
└── star
    ├── chrLength.txt
    ├── chrNameLength.txt
    ├── chrName.txt
    ├── chrStart.txt
    ├── exonGeTrInfo.tab
    ├── exonInfo.tab
    ├── geneInfo.tab
    ├── Genome
    ├── genomeParameters.txt
    ├── SA
    ├── SAindex
    ├── sjdbInfo.txt
    ├── sjdbList.fromGTF.out.tab
    ├── sjdbList.out.tab
    └── transcriptInfo.tab
```

## Run CellRanger `count`

Now we're ready to run CellRanger `count`, which will map the reads and generate a counts matrix. Here again, we load the pre-installed CellRanger module (note that you can specify a version if you need to use one that isn't the most recent) and then call `cellranger count`, specifying a name for the run, the location of your FASTQ files, the transcriptome (the genome dir generated by `mkref`), and the cores and memory to use.

**Note:** You will run CellRanger `count` independently on each sample. The example below is for sample S1.

```
export DATA_DIR=/data/project/daylab/2023-JD-0062/
export WORK_DIR=/scratch/cenewman/CRcount1
cd $WORK_DIR

module load CellRanger

cellranger count --id=CR_outputs_2023-JD-0062 \
                 --fastqs=$DATA_DIR/fastqs/lacZ_S1 \
                 --transcriptome=/data/user/cenewman/reference/mRatBN7_2 \
                 --localcores=12 \
                 --localmem=144

date
```

When the run finishes, move the output from scratch to $USER_DATA.

You should see the [outputs described in the 10X documentation](https://www.10xgenomics.com/support/software/cell-ranger/analysis/outputs/cr-outputs-overview). The file `web_summary.html` opened in your browser gives a useful summary of the run. The `possorted_genome_bam.bam` file can be useful if you need to troubleshoot read mapping but otherwise we don't really use it. The three directories are what we will be using for downstream analysis:

```
outs
└── analysis
    ├── clustering
    ├── diffexp
    ├── pca
    ├── tsne
    ├── umap
└── filtered_feature_bc_matrix
    ├── barcodes.tsv.gz
    ├── features.tsv.gz
    ├── matrix.mtx.gz
└── raw_feature_bc_matrix
    ├── barcodes.tsv.gz
    ├── features.tsv.gz
    └── matrix.mtx.gz
```

If you will be running R on your local computer, download those output directories for all samples. (Be sure to download each sample's output into its own directory to avoid overwriting files that have the same filename.)

Now we are ready to analyze the output in R!
